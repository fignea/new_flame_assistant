# üìã Plan Completo de Desarrollo - An√°lisis Comparativo

## **üîç Estado Actual vs Estado Deseado**

### **1. M√ìDULO DE INTEGRACIONES** 
**Estado Actual: ‚úÖ 80% Completo**

| Funcionalidad | Estado Actual | Estado Deseado | Cambios Necesarios |
|---------------|---------------|----------------|-------------------|
| **WhatsApp Web** | ‚úÖ Conecta y desconecta | ‚úÖ Funcional | Ninguno |
| **Web Chat** | ‚úÖ Widget funcional | ‚úÖ Funcional | Ninguno |
| **Facebook/Instagram** | ‚ùå No implementado | üîÑ Pr√≥ximamente | Agregar integraciones |
| **WhatsApp Business API** | ‚ùå No implementado | üîÑ Pr√≥ximamente | Agregar integraciones |
| **Estado de conexiones** | ‚úÖ B√°sico | ‚úÖ Funcional | Ninguno |
| **Sincronizaci√≥n autom√°tica** | ‚ùå No implementado | üîÑ Necesario | Implementar |

**Cambios Requeridos:**
- ‚úÖ Mantener funcionalidad actual
- üîÑ Agregar sincronizaci√≥n autom√°tica de contactos
- üîÑ Preparar estructura para nuevas integraciones

---

### **2. M√ìDULO DE ASISTENTES**
**Estado Actual: ‚úÖ 95% Completo**

| Funcionalidad | Estado Actual | Estado Deseado | Cambios Necesarios |
|---------------|---------------|----------------|-------------------|
| **CRUD B√°sico** | ‚úÖ Funcional | ‚úÖ Funcional | Ninguno |
| **Tipos de asistente** | ‚úÖ Auto/IA | ‚úÖ Funcional | Ninguno |
| **Configuraci√≥n de horarios** | ‚úÖ B√°sico | ‚úÖ Funcional | Ninguno |
| **Integraci√≥n con OpenAI** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Plantillas de respuestas** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Asignaci√≥n autom√°tica** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Respuestas autom√°ticas** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Entrenamiento con documentos** | ‚ùå No implementado | üîÑ Importante | Implementar |

**Cambios Requeridos:**
- ‚úÖ **CR√çTICO:** ‚úÖ Implementar integraci√≥n real con OpenAI
- ‚úÖ **CR√çTICO:** ‚úÖ Crear sistema de plantillas de respuestas
- ‚úÖ **CR√çTICO:** ‚úÖ Implementar l√≥gica de asignaci√≥n autom√°tica
- ‚úÖ **CR√çTICO:** ‚úÖ Conectar respuestas autom√°ticas con inbox
- üîÑ **IMPORTANTE:** Sistema de entrenamiento con documentos

---

### **3. M√ìDULO DE INBOX**
**Estado Actual: ‚úÖ 90% Completo**

| Funcionalidad | Estado Actual | Estado Deseado | Cambios Necesarios |
|---------------|---------------|----------------|-------------------|
| **Vista de conversaciones** | ‚úÖ Funcional | ‚úÖ Funcional | Ninguno |
| **Mensajes en tiempo real** | ‚úÖ Socket.IO | ‚úÖ Funcional | Ninguno |
| **Filtros b√°sicos** | ‚úÖ Estado/Prioridad | ‚úÖ Funcional | Ninguno |
| **Asignaci√≥n de asistentes** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Etiquetas y categorizaci√≥n** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Historial por contacto** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **B√∫squeda avanzada** | ‚úÖ Mejorada | ‚úÖ Funcional | Ninguno |
| **Notificaciones** | ‚ùå No implementado | üîÑ Importante | Implementar |

**Cambios Requeridos:**
- ‚úÖ **CR√çTICO:** ‚úÖ Mostrar asistente asignado en cada conversaci√≥n
- ‚úÖ **CR√çTICO:** ‚úÖ Implementar asignaci√≥n manual/autom√°tica
- ‚úÖ **IMPORTANTE:** ‚úÖ Sistema de etiquetas
- ‚úÖ **IMPORTANTE:** ‚úÖ Historial de conversaciones por contacto
- üîÑ **IMPORTANTE:** Notificaciones en tiempo real

---

### **4. M√ìDULO DE CONTACTOS**
**Estado Actual: ‚úÖ 85% Completo**

| Funcionalidad | Estado Actual | Estado Deseado | Cambios Necesarios |
|---------------|---------------|----------------|-------------------|
| **CRUD B√°sico** | ‚úÖ Funcional | ‚úÖ Funcional | Ninguno |
| **Sincronizaci√≥n WhatsApp** | ‚úÖ B√°sica | ‚úÖ Funcional | Ninguno |
| **Filtros por tipo** | ‚úÖ Individual/Grupo | ‚úÖ Funcional | Ninguno |
| **Creaci√≥n autom√°tica** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Historial de interacciones** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Notas por contacto** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Segmentaci√≥n** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |
| **Estad√≠sticas** | ‚úÖ Implementado | ‚úÖ Funcional | Ninguno |

**Cambios Requeridos:**
- ‚úÖ **CR√çTICO:** ‚úÖ Creaci√≥n autom√°tica desde mensajes entrantes
- ‚úÖ **CR√çTICO:** ‚úÖ Historial completo de interacciones
- ‚úÖ **IMPORTANTE:** ‚úÖ Sistema de notas
- ‚úÖ **IMPORTANTE:** ‚úÖ Segmentaci√≥n de contactos

---

## **üóÑÔ∏è BASE DE DATOS - Estado Actual**

### **Tablas Existentes (‚úÖ Completadas)**
```sql
-- Estas tablas est√°n implementadas y funcionando
users ‚úÖ
whatsapp_sessions ‚úÖ  
contacts ‚úÖ (con campos adicionales implementados)
messages ‚úÖ (con campos adicionales implementados)
scheduled_messages ‚úÖ
assistants ‚úÖ (con campos adicionales implementados)
web_visitors ‚úÖ
web_conversations ‚úÖ
web_messages ‚úÖ
```

### **Nuevas Tablas Implementadas (‚úÖ Completadas)**

```sql
-- 1. Asignaciones de asistentes a conversaciones ‚úÖ
CREATE TABLE assistant_assignments (
    id SERIAL PRIMARY KEY,
    assistant_id INTEGER REFERENCES assistants(id) ON DELETE CASCADE,
    conversation_id VARCHAR(255) NOT NULL,
    platform VARCHAR(50) NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    assignment_type VARCHAR(50) DEFAULT 'automatic'
);

-- 2. Plantillas de respuestas ‚úÖ
CREATE TABLE response_templates (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    trigger_keywords TEXT[],
    conditions JSONB,
    category VARCHAR(100),
    priority INTEGER DEFAULT 0,
    response_delay INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. Sistema de etiquetas ‚úÖ
CREATE TABLE tags (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    color VARCHAR(7) DEFAULT '#3B82F6',
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 4. Etiquetas de conversaciones ‚úÖ
CREATE TABLE conversation_tags (
    conversation_id VARCHAR(255) NOT NULL,
    platform VARCHAR(50) NOT NULL,
    tag_id INTEGER REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (conversation_id, platform, tag_id)
);

-- 5. Etiquetas de contactos ‚úÖ
CREATE TABLE contact_tags (
    contact_id INTEGER REFERENCES contacts(id) ON DELETE CASCADE,
    tag_id INTEGER REFERENCES tags(id) ON DELETE CASCADE,
    PRIMARY KEY (contact_id, tag_id)
);

-- 6. Historial de interacciones ‚úÖ
CREATE TABLE interaction_history (
    id SERIAL PRIMARY KEY,
    contact_id INTEGER REFERENCES contacts(id) ON DELETE CASCADE,
    conversation_id VARCHAR(255) NOT NULL,
    platform VARCHAR(50) NOT NULL,
    interaction_type VARCHAR(50) NOT NULL,
    content TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 7. Notas de contactos ‚úÖ
CREATE TABLE contact_notes (
    id SERIAL PRIMARY KEY,
    contact_id INTEGER REFERENCES contacts(id) ON DELETE CASCADE,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    is_private BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. Configuraci√≥n de asistentes ‚úÖ
CREATE TABLE assistant_configs (
    id SERIAL PRIMARY KEY,
    assistant_id INTEGER REFERENCES assistants(id) ON DELETE CASCADE,
    config_key VARCHAR(100) NOT NULL,
    config_value JSONB NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(assistant_id, config_key)
);
```

### **Modificaciones a Tablas Existentes (‚úÖ Completadas)**

```sql
-- Campos agregados a la tabla contacts ‚úÖ
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS avatar_url TEXT;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS is_blocked BOOLEAN DEFAULT FALSE;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS last_message_at TIMESTAMP;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS unread_count INTEGER DEFAULT 0;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS assigned_assistant_id INTEGER REFERENCES assistants(id);
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS priority VARCHAR(20) DEFAULT 'normal';
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'active';
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS notes TEXT;

-- Campos agregados a la tabla assistants ‚úÖ
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS prompt TEXT;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT TRUE;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS openai_api_key TEXT;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS model VARCHAR(50) DEFAULT 'gpt-3.5-turbo';
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS max_tokens INTEGER DEFAULT 150;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS temperature DECIMAL(2,1) DEFAULT 0.7;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS auto_assign BOOLEAN DEFAULT TRUE;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS response_delay INTEGER DEFAULT 0;
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS type VARCHAR(20) DEFAULT 'ai';
ALTER TABLE assistants ADD COLUMN IF NOT EXISTS integrations TEXT[];

-- Campos agregados a la tabla messages ‚úÖ
ALTER TABLE messages ADD COLUMN IF NOT EXISTS assistant_id INTEGER REFERENCES assistants(id);
ALTER TABLE messages ADD COLUMN IF NOT EXISTS is_auto_response BOOLEAN DEFAULT FALSE;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS template_id INTEGER REFERENCES response_templates(id);
```

---

## **üîÑ FLUJO CORRELATIVO - Estado Actual**

### **Flujo Anterior (‚ùå Limitado)**
```
Mensaje llega ‚Üí Se muestra en inbox ‚Üí Usuario responde manualmente
```

### **Flujo Actual (‚úÖ Implementado)**
```
Mensaje llega ‚Üí 
  ‚îú‚îÄ‚îÄ ‚úÖ Crear/actualizar contacto autom√°ticamente
  ‚îú‚îÄ‚îÄ ‚úÖ Asignar asistente (autom√°tico o manual)
  ‚îú‚îÄ‚îÄ ‚úÖ Verificar si asistente debe responder
  ‚îú‚îÄ‚îÄ ‚úÖ Generar respuesta autom√°tica (si aplica)
  ‚îú‚îÄ‚îÄ ‚úÖ Enviar respuesta
  ‚îú‚îÄ‚îÄ ‚úÖ Registrar en historial
  ‚îú‚îÄ‚îÄ ‚úÖ Aplicar etiquetas autom√°ticas
  ‚îî‚îÄ‚îÄ ‚úÖ Actualizar estad√≠sticas
```

---

## **üìÖ PLAN DE IMPLEMENTACI√ìN - Estado Actual**

### **FASE 1: Base de Datos ‚úÖ COMPLETADA**
**Prioridad: üî¥ CR√çTICA - ‚úÖ FINALIZADA**

| D√≠a | Tarea | Archivos Modificados | Estado |
|-----|-------|---------------------|--------|
| 1 | Crear nuevas tablas | `scripts/init-db.sql` | ‚úÖ Completado |
| 2 | Modificar tablas existentes | `scripts/init-db.sql` | ‚úÖ Completado |
| 3 | Crear migraciones | `scripts/migrate-assistant-system.sql` | ‚úÖ Completado |
| 4 | Actualizar tipos TypeScript | `backend/src/types/index.ts` | ‚úÖ Completado |
| 5 | Probar migraciones | Base de datos | ‚úÖ Completado |

### **FASE 2: Backend - Servicios ‚úÖ COMPLETADA**
**Prioridad: üî¥ CR√çTICA - ‚úÖ FINALIZADA**

| D√≠a | Tarea | Archivos Creados/Modificados | Estado |
|-----|-------|---------------------------|--------|
| 1 | Servicio de Asignaci√≥n | `backend/src/services/AssignmentService.ts` | ‚úÖ Completado |
| 2 | Servicio de Plantillas | `backend/src/services/TemplateService.ts` | ‚úÖ Completado |
| 3 | Servicio de Etiquetas | `backend/src/services/TagService.ts` | ‚úÖ Completado |
| 4 | Integraci√≥n OpenAI | `backend/src/services/OpenAIService.ts` | ‚úÖ Completado |
| 5 | L√≥gica de Respuestas Autom√°ticas | `backend/src/services/AutoResponseService.ts` | ‚úÖ Completado |

### **FASE 3: Backend - Controladores ‚úÖ COMPLETADA**
**Prioridad: üî¥ CR√çTICA - ‚úÖ FINALIZADA**

| D√≠a | Tarea | Archivos Creados/Modificados | Estado |
|-----|-------|---------------------------|--------|
| 1 | Controlador de Asignaciones | `backend/src/controllers/AssignmentController.ts` | ‚úÖ Completado |
| 2 | Controlador de Plantillas | `backend/src/controllers/TemplateController.ts` | ‚úÖ Completado |
| 3 | Controlador de Etiquetas | `backend/src/controllers/TagController.ts` | ‚úÖ Completado |
| 4 | Controlador de Respuestas Autom√°ticas | `backend/src/controllers/AutoResponseController.ts` | ‚úÖ Completado |
| 5 | Actualizar AssistantsController | `backend/src/controllers/AssistantsController.ts` | ‚úÖ Completado |

### **FASE 4: Frontend - Componentes ‚úÖ COMPLETADA**
**Prioridad: üü° IMPORTANTE - ‚úÖ FINALIZADA**

| D√≠a | Tarea | Archivos Creados/Modificados | Estado |
|-----|-------|---------------------------|--------|
| 1 | P√°gina de Plantillas | `frontend/src/pages/templates/TemplatesPage.tsx` | ‚úÖ Completado |
| 2 | P√°gina de Etiquetas | `frontend/src/pages/tags/TagsPage.tsx` | ‚úÖ Completado |
| 3 | Dashboard de Estad√≠sticas | `frontend/src/pages/dashboard/DashboardPage.tsx` | ‚úÖ Completado |
| 4 | Actualizar InboxPage | `frontend/src/pages/inbox/InboxPage.tsx` | ‚úÖ Completado |
| 5 | Actualizar AssistantsPage | `frontend/src/pages/assistants/AssistantsPage.tsx` | ‚úÖ Completado |

### **FASE 5: Integraci√≥n y Testing ‚úÖ COMPLETADA**
**Prioridad: üü° IMPORTANTE - ‚úÖ FINALIZADA**

| D√≠a | Tarea | Archivos Modificados | Estado |
|-----|-------|---------------------|--------|
| 1 | Rutas y Middleware | `backend/src/routes/*.ts` | ‚úÖ Completado |
| 2 | API Service Frontend | `frontend/src/services/api.service.ts` | ‚úÖ Completado |
| 3 | Hooks personalizados | `frontend/src/hooks/*.ts` | ‚úÖ Completado |
| 4 | Testing de flujo completo | Varios archivos | ‚úÖ Completado |
| 5 | Correcci√≥n de errores | Varios archivos | ‚úÖ Completado |

### **FASE 6: Mejoras de UX/UI üîÑ EN PROGRESO**
**Prioridad: üü¢ OPCIONAL - üîÑ PENDIENTE**

| D√≠a | Tarea | Archivos a Crear/Modificar | Estado |
|-----|-------|---------------------------|--------|
| 1 | Notificaciones en tiempo real | `frontend/src/hooks/useNotifications.ts` | üîÑ Pendiente |
| 2 | B√∫squeda avanzada | `frontend/src/components/AdvancedSearch.tsx` | üîÑ Pendiente |
| 3 | Mejoras visuales | Varios componentes | üîÑ Pendiente |
| 4 | Optimizaciones | Varios archivos | üîÑ Pendiente |
| 5 | Documentaci√≥n adicional | `README.md` | üîÑ Pendiente |

---

## **üìä RESUMEN DE CAMBIOS**

### **Archivos a Crear (üÜï 15 archivos)**
- `backend/src/services/AssignmentService.ts`
- `backend/src/services/TemplateService.ts`
- `backend/src/services/TagService.ts`
- `backend/src/services/OpenAIService.ts`
- `backend/src/services/AutoResponseService.ts`
- `backend/src/controllers/AssignmentController.ts`
- `backend/src/controllers/TemplateController.ts`
- `backend/src/controllers/TagController.ts`
- `frontend/src/components/AssistantAssignment.tsx`
- `frontend/src/components/TemplateManager.tsx`
- `frontend/src/components/TagManager.tsx`
- `frontend/src/hooks/useNotifications.ts`
- `frontend/src/components/AdvancedSearch.tsx`
- `scripts/migrate-assignments.sql`
- `scripts/migrate-templates.sql`

### **Archivos a Modificar (üîÑ 12 archivos)**
- `scripts/init-db.sql` - Agregar nuevas tablas
- `backend/src/types/index.ts` - Nuevos tipos
- `backend/src/controllers/WhatsAppController.ts` - Integrar asignaciones
- `backend/src/controllers/AssistantsController.ts` - Agregar plantillas
- `backend/src/services/WhatsAppService.ts` - Respuestas autom√°ticas
- `backend/src/server.ts` - Nuevos eventos Socket.IO
- `frontend/src/pages/inbox/InboxPage.tsx` - Mostrar asignaciones
- `frontend/src/pages/assistants/AssistantsPage.tsx` - Gesti√≥n de plantillas
- `frontend/src/pages/contacts/ContactsPage.tsx` - Historial de interacciones
- `frontend/src/services/api.service.ts` - Nuevas APIs
- `frontend/src/contexts/AppContext.tsx` - Nuevos estados
- `README.md` - Documentaci√≥n actualizada

### **Tiempo Total Estimado: 120 horas (3 semanas a tiempo completo)**

---

## **üöÄ PR√ìXIMOS PASOS**

1. **Revisar y aprobar este plan**
2. **Comenzar con Fase 1: Base de Datos**
3. **Configurar entorno de desarrollo**
4. **Implementar migraciones de base de datos**
5. **Desarrollar servicios backend**
6. **Integrar con frontend**
7. **Testing y debugging**
8. **Deploy y documentaci√≥n**

---

## **üìù NOTAS DE DESARROLLO**

- Mantener compatibilidad con funcionalidades existentes
- Implementar cambios de forma incremental
- Testing continuo en cada fase
- Documentar todos los cambios
- Backup de base de datos antes de migraciones

---

**√öltima actualizaci√≥n:** $(date)
**Versi√≥n del plan:** 1.0
**Estado:** En desarrollo
